<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/scenes/GameScene.js | micrungeon</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Phaser 3 hybrid game"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="micrungeon"><meta property="twitter:description" content="Phaser 3 hybrid game"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/blackjack26/micrungeon"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Difficulty">Difficulty</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Direction">Direction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Edge">Edge</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Orientation">Orientation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RoomType">RoomType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Door">Door</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-DungeonConfig">DungeonConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-HealthBarConfig">HealthBarConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ItemUseConfig">ItemUseConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RandomNumberRange">RandomNumberRange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RoomAttachment">RoomAttachment</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RoomConfig">RoomConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SpriteConfig">SpriteConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-TilePosition">TilePosition</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#battle">battle</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/battle/Battle.js~Battle.html">Battle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/battle/BattleDrop.js~BattleDrop.html">BattleDrop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/battle/HealthBar.js~HealthBar.html">HealthBar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#dungeon">dungeon</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/dungeon/Dungeon.js~Dungeon.html">Dungeon</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/dungeon/Hallway.js~Hallway.html">Hallway</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/dungeon/Room.js~Room.html">Room</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/dungeon/TilemapVisibility.js~TilemapVisibility.html">TilemapVisibility</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-debugMap">debugMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Tileset">Tileset</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Tiles">Tiles</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#entity">entity</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/entity/Enemy.js~Enemy.html">Enemy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/entity/Entity.js~Entity.html">Entity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/entity/Player.js~Player.html">Player</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#entity-items">entity/items</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/entity/items/BugSpray.js~BugSpray.html">BugSpray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/entity/items/Injection.js~Injection.html">Injection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/entity/items/Inventory.js~Inventory.html">Inventory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/entity/items/Item.js~Item.html">Item</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/entity/items/ItemDrop.js~ItemDrop.html">ItemDrop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/entity/items/Timelapse.js~Timelapse.html">Timelapse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/entity/items/VorpalSword.js~VorpalSword.html">VorpalSword</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-itemClass">itemClass</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ItemType">ItemType</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#minigames">minigames</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/minigames/DanceDance.js~DanceDance.html">DanceDance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/minigames/MiniGame.js~MiniGame.html">MiniGame</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#scenes">scenes</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scenes/BootScene.js~BootScene.html">BootScene</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scenes/GameScene.js~GameScene.html">GameScene</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scenes/InventoryScene.js~InventoryScene.html">InventoryScene</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scenes/PauseScene.js~PauseScene.html">PauseScene</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scenes/TitleScene.js~TitleScene.html">TitleScene</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#scenes-elements">scenes/elements</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/scenes/elements/Message.js~Message.html">Message</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#util">util</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util/KeyBinding.js~KeyBinding.html">KeyBinding</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util/LightPipeline.js~LightPipeline.html">LightPipeline</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/util/Random.js~Random.html">Random</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addDynamicAnim">addDynamicAnim</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addStaticAnim">addStaticAnim</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createAnimations">createAnimations</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/scenes/GameScene.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import KeyBinding from &apos;../util/KeyBinding&apos;;
import Dungeon from &apos;../dungeon/Dungeon&apos;;
import Hallway from &apos;../dungeon/Hallway&apos;;
import { Edge, Orientation, RoomType } from &apos;../globals&apos;;
import Tileset from &apos;../dungeon/TileMappings&apos;;
import TilemapVisibility from &apos;../dungeon/TilemapVisibility&apos;;
import { Player } from &apos;../entity&apos;;
import Battle from &apos;../battle/Battle&apos;;
import BattleDrop from &apos;../battle/BattleDrop&apos;;
import { ItemType } from &apos;../entity/items&apos;;

/**
 * The game scene is the main scene used when the player is in actual game play.
 * All mini game and dungeon gameplay will be from this scene.
 */
export default class GameScene extends Phaser.Scene {
  /**
   * Initializes the game scene
   * @constructor
   */
  constructor() {
    super( { key: &apos;GameScene&apos; } );
  }

  /**
   * @override
   */
  preload() {
  }

  /**
   * @override
   */
  create() {
    /**
     * A collection of the timeouts currently pending based on the number of
     * rooms visited since the timeout was added
     * @type {Map.&lt;string, {remaining: number, callback: function}&gt;}
     */
    this.roomCooloffs = {};
    
    /**
     * A collection of the keys available for use in the game
     * @type {Object}
     */
    this.keys = KeyBinding.createKeys( this,
      [ &apos;up&apos;, &apos;left&apos;, &apos;right&apos;, &apos;down&apos;, &apos;space&apos;, &apos;interact&apos;, &apos;pause&apos; ] );
    
    /**
     * The scene groups to hold all of the enemies present
     * @type {Phaser.GameObjects.Group}
     */
    this.enemyGroup = this.add.group();
    
    /**
     * The current battle in progress
     * @type {Battle}
     */
    this.battle = null;
    
    /**
     * The dungeon the player is currently in
     * @type {Dungeon}
     */
    this.dungeon = null;
    
    /**
     * The width of the map in pixels
     * @type {number}
     */
    this.mapWidthInPixels = -1;
    
    /**
     * The height of the map in pixels
     * @type {number}
     */
    this.mapHeightInPixels = -1;
    
    /**
     * The current map displayed to the user
     * @type {Phaser.Tilemaps.Tilemap}
     */
    this.map = null;
    
    /**
     * The general layer building the dungeon (walls, floors)
     * @type {Phaser.Tilemaps.DynamicTilemapLayer}
     */
    this.groundLayer = null;
    
    /**
     * The layer that contains all of the objects in the dungeon (i.e. doors)
     * @type {Phaser.Tilemaps.DynamicTilemapLayer}
     */
    this.stuffLayer = null;
    
    /**
     * Used to show / hide the dungeon
     * @type {TilemapVisibility}
     */
    this.tilemapVisibility = null;
    
    /**
     * The player in the dungeon
     * @type {Player}
     */
    this.player = null;
    
    this.createDungeonMap();
    this.createPlayer();
    this.formatCamera();
    this.configCameraHUD();
  }

  /**
   * @override
   */
  update( time, delta ) {
    this.player.update( time, delta );
    if ( this.battle &amp;&amp; this.battle.active ) {
      this.battle.update();
    }
    else {
      this.updateMapVisibility();
    }

    if ( this.keys.interact.isDown ) {
      this.openInventory();
    }

    if ( this.keys.pause.isDown ) {
      this.pause();
    }
  }

  /**
   * Pauses the game
   */
  pause() {
    this.input.keyboard.resetKeys();
    this.scene
      .launch( &apos;PauseScene&apos;, { parent: this } )
      .bringToTop( &apos;PauseScene&apos; )
      .pause();
  }

  /**
   * Unpauses the game
   */
  unpause() {
    this.scene.stop( &apos;PauseScene&apos; );
    this.input.keyboard.resetKeys();
    this.scene.resume();
  }

  /**
   * Opens the inventory
   */
  openInventory() {
    this.input.keyboard.resetKeys();
    this.scene
      .launch( &apos;InventoryScene&apos;, {
        parent: this,
        inventory: this.player.inventory,
        context: ItemType.ANY
      } )
      .bringToTop( &apos;InventoryScene&apos; )
      .pause();
  }

  /**
   * Closes the inventory
   * @param {Item} item The item selected from the inventory
   */
  closeInventory( item ) {
    this.scene.stop( &apos;InventoryScene&apos; );
    this.input.keyboard.resetKeys();
    this.scene.resume();

    if ( item &amp;&amp; item.itemType === ItemType.ANY ) {
      item.use( {
        player: this.player,
        scene: this,
        battle: this.battle
      } );
      this.player.inventory.items.splice( item.inventoryIndex, 1 );
    }
  }

  /**
   * Creates the HUD camera
   */
  configCameraHUD() {
    const { width, height } = this.game.config;
    const HUD_X = -width;
    const hudCamera = this.cameras.add( 0, 0, width, height, false, &apos;HUD&apos; );
    hudCamera.scrollX = HUD_X;
  }

  /**
   * Updates the visibility of the map
   */
  updateMapVisibility() {
    const playerTileX = this.groundLayer.worldToTileX( this.player.x );
    const playerTileY = this.groundLayer.worldToTileY( this.player.y );
    const playerRoom = this.dungeon.getRoomAt( playerTileX, playerTileY );

    if ( this.tilemapVisibility.setActiveRoom( playerRoom ) ) {
      if ( !playerRoom.entered ) {
        // Battle Room
        if ( playerRoom.type === RoomType.BATTLE &amp;&amp; !this.preventSpawn ) {
          const edge = playerRoom.getEdge( playerTileX, playerTileY );
          if ( Edge.TOP === edge ) {
            this.player.setDestination(
              this.player.x,
              this.player.y + this.map.tileHeight * 2,
              () =&gt; {
                this.beginCombat( playerRoom, Edge.TOP );
              }
            );
          }
          else if ( Edge.BOTTOM === edge ) {
            this.player.setDestination(
              this.player.x,
              this.player.y - this.map.tileHeight * 2,
              () =&gt; {
                this.beginCombat( playerRoom, Edge.BOTTOM );
              }
            );
          }
          else if ( Edge.LEFT === edge ) {
            this.player.setDestination(
              this.player.x + this.map.tileWidth * 2,
              this.player.y,
              () =&gt; {
                this.beginCombat( playerRoom, Edge.LEFT );
              }
            );
          }
          // Right
          else if ( Edge.RIGHT === edge ) {
            this.player.setDestination(
              this.player.x - this.map.tileWidth * 2,
              this.player.y,
              () =&gt; {
                this.beginCombat( playerRoom, Edge.RIGHT );
              }
            );
          }
        }
        // Item Room
        else if ( playerRoom.type === RoomType.ITEM ) {
          playerRoom.spawnItem( this );
        }
      }

      // Only reduce room cooloff when entering rooms
      if ( !( playerRoom instanceof Hallway ) ) {
        const shouldDelete = [];
        Object.keys( this.roomCooloffs ).forEach( ( key ) =&gt; {
          this.roomCooloffs[ key ].remaining--;
          if ( this.roomCooloffs[ key ].remaining &lt;= 0 ) {
            this.roomCooloffs[ key ].callback();
            shouldDelete.push( key );
          }
        } );
        shouldDelete.forEach( ( key ) =&gt; {
          delete this.roomCooloffs[ key ];
        } );
      }
    }

    playerRoom.entered = true;
  }

  /**
   * Begins combat inside of a battle room
   * @param {Room} room The room to begin a battle in
   * @param {number} edge The edge the player entered on
   */
  beginCombat( room, edge ) {
    this.battle = new Battle( room, edge, this );
    this.battle.begin();
  }

  /**
   * Ends the combat inside of the battle room
   */
  endCombat() {
    this.battle.end()
      .then( () =&gt; this.battle = null );
  }

  /**
   * Creates the map of the dungeon
   */
  createDungeonMap() {
    this.dungeon = new Dungeon();

    // Initialize Dungeon Map
    const map = this.make.tilemap( {
      tileWidth: 32,
      tileHeight: 32,
      width: this.dungeon.width,
      height: this.dungeon.height
    } );
    this.mapWidthInPixels = map.widthInPixels;
    this.mapHeightInPixels = map.heightInPixels;
    this.map = map;

    // Create Tilesets &amp; Layers
    const tileset = map.addTilesetImage( &apos;dungeon_tiles&apos;, null, 32, 32, 1, 2 );
    this.groundLayer =
      map.createBlankDynamicLayer( &apos;Ground&apos;, tileset ).fill( Tileset.BLANK );
    this.stuffLayer = map.createBlankDynamicLayer( &apos;Stuff&apos;, tileset );
    const shadowLayer = map.createBlankDynamicLayer( &apos;Shadow&apos;, tileset )
      .fill( Tileset.BLANK );

    this.tilemapVisibility = new TilemapVisibility( this, shadowLayer );

    // Create Rooms in Dungeon
    this.dungeon.rooms.forEach( ( room ) =&gt; {
      if ( room instanceof Hallway ) {
        this.createHallway( room );
      }
      else {
        this.createRoom( room );
      }
    } );

    // Collision
    this.groundLayer.setCollisionByExclusion( [ -1, 9 ] );
    this.stuffLayer.setCollision( [ 24, 25, 26, 32, 40 ] );
  }

  /**
   * Creates a hallway on the ground layer
   * @param {Hallway} hallway the hallway being added
   */
  createHallway( hallway ) {
    const { width, height, left, right, top, bottom } = hallway;
    if ( hallway.orientation === Orientation.HORIZONTAL ) {
      this.groundLayer.fill( Tileset.WALL.TOP, left, top, width, 1 );
      this.groundLayer.fill( Tileset.FLOOR, left, top + 1, width, 1 );
      this.groundLayer.fill( Tileset.WALL.BOTTOM, left, bottom, width, 1 );
    }
    else if ( hallway.orientation === Orientation.VERTICAL ) {
      this.groundLayer.fill( Tileset.WALL.LEFT, left, top, 1, height );
      this.groundLayer.fill( Tileset.FLOOR, left + 1, top, 1, height );
      this.groundLayer.fill( Tileset.WALL.RIGHT, right, top, 1, height );
    }
  }

  /**
   * Creates a room on the ground layer
   * @param {Room} room the room being added
   */
  createRoom( room ) {
    const { x, y, width, height, left, right, top, bottom } = room;

    // Fill the floor
    this.groundLayer.fill( Tileset.FLOOR, x + 1, y + 1, width - 2, height - 2 );

    // Place the room corners tiles
    this.groundLayer.putTileAt( Tileset.WALL.TOP_LEFT, left, top );
    this.groundLayer.putTileAt( Tileset.WALL.TOP_RIGHT, right, top );
    this.groundLayer.putTileAt( Tileset.WALL.BOTTOM_LEFT, left, bottom );
    this.groundLayer.putTileAt( Tileset.WALL.BOTTOM_RIGHT, right, bottom );

    // Fill the walls
    this.groundLayer.fill( Tileset.WALL.TOP, left + 1, top, width - 2, 1 );
    this.groundLayer.fill( Tileset.WALL.BOTTOM, left + 1,
      bottom, width - 2, 1 );
    this.groundLayer.fill( Tileset.WALL.LEFT, left, top + 1, 1, height - 2 );
    this.groundLayer.fill( Tileset.WALL.RIGHT, right, top + 1,
      1, height - 2 );

    // Doors
    let tl; // Top-Left
    let tr; // Top-Right
    let bl; // Bottom-Left
    let br; // Bottom-Right
    let lt; // Left-Top
    let lb; // Left-Bottom
    let rt; // Right-Top
    let rb; // Right-Bottom
    room.doors.forEach( ( door ) =&gt; {
      this.groundLayer.putTileAt( Tileset.FLOOR,
        x + door.x, y + door.y );

      // TOP
      if ( Edge.TOP === door.edge ) {
        if ( door.x === 1 ) {
          this.groundLayer.putTilesAt( Tileset.DOOR.TOP.LEFT, x, y );
          tl = true;
        }
        else if ( door.x === room.width - 2 ) {
          this.groundLayer.putTilesAt( Tileset.DOOR.TOP.RIGHT,
            x + door.x - 1, y );
          tr = true;
        }
        else {
          this.groundLayer.putTilesAt( Tileset.DOOR.TOP.MIDDLE,
            x + door.x - 1, y );
        }
      }
      // BOTTOM
      else if ( Edge.BOTTOM === door.edge ) {
        if ( door.x === 1 ) {
          this.groundLayer.putTilesAt( Tileset.DOOR.BOTTOM.LEFT,
            x, y + height - 1 );
          bl = true;
        }
        else if ( door.x === room.width -